<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pixel Company â€“ Gorilla Locomotion Fixed</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <script>
    /* =========================================================
       HAND FOLLOW
    ========================================================= */
    AFRAME.registerComponent('hand-follow', {
      schema: { target: { type: 'selector' } },
      tick: function () {
        if (!this.data.target) return;
        this.el.object3D.position.copy(this.data.target.object3D.position);
        this.el.object3D.quaternion.copy(this.data.target.object3D.quaternion);
      }
    });

    /* =========================================================
       FIXED GORILLA PHYSICS
    ========================================================= */
    AFRAME.registerComponent('gorilla-physics', {
      schema: {
        rig: { type: 'selector' },
        strength: { type: 'number', default: 2.0 },
        gravity: { type: 'number', default: -15 },  // Heavier gravity stops floating
        maxVelocity: { type: 'number', default: 10 }
      },

      init: function () {
        this.velocity = new THREE.Vector3();
        this.prevPos = new THREE.Vector3();
        this.currPos = new THREE.Vector3();
        this.handVel = new THREE.Vector3();
        this.grounded = false;
        this.cooldown = 0;

        this.raycaster = new THREE.Raycaster();
        this.downVec = new THREE.Vector3(0, -1, 0);
        this.rayOrigin = new THREE.Vector3();

        this.climbables = [];
        this.el.sceneEl.addEventListener('loaded', () => {
          const els = this.el.sceneEl.querySelectorAll('.climbable');
          this.climbables = Array.from(els).map(e => e.object3D);
          // Start the rig exactly at 0
          if(this.data.rig) this.data.rig.object3D.position.y = 0;
        });
      },

      tick: function (time, deltaTime) {
        if (!deltaTime || !this.data.rig) return;

        const rig = this.data.rig.object3D;
        const dt = deltaTime / 1000;
        if (this.cooldown > 0) this.cooldown -= dt;

        this.el.object3D.getWorldPosition(this.currPos);
        this.handVel.copy(this.currPos).sub(this.prevPos).divideScalar(dt);
        this.prevPos.copy(this.currPos);

        // Surface Check
        this.rayOrigin.copy(this.currPos);
        this.raycaster.set(this.rayOrigin, this.downVec);
        const hits = this.raycaster.intersectObjects(this.climbables, true);

        // FIXED JUMP DETECTION:
        // 1. Must be close to surface (distance < 0.1)
        // 2. Must be moving hand DOWN significantly (handVel.y < -0.5)
        // 3. Not on cooldown
        if (hits.length > 0 && hits[0].distance < 0.1 && this.handVel.y < -0.5 && this.cooldown <= 0) {
          
          let vX = -this.handVel.x * this.data.strength;
          let vY = -this.handVel.y * (this.data.strength * 1.3);
          let vZ = -this.handVel.z * this.data.strength;

          this.velocity.x = THREE.MathUtils.clamp(vX, -this.data.maxVelocity, this.data.maxVelocity);
          this.velocity.y = THREE.MathUtils.clamp(vY, -this.data.maxVelocity, this.data.maxVelocity);
          this.velocity.z = THREE.MathUtils.clamp(vZ, -this.data.maxVelocity, this.data.maxVelocity);

          this.grounded = false;
          this.cooldown = 0.15; // Longer cooldown prevents "double-jumping" by accident

          const gamepad = this.el.components['tracked-controls']?.controller;
          if (gamepad?.hapticActuators?.length) {
            gamepad.hapticActuators[0].pulse(0.6, 50);
          }
        }

        // Apply Gravity always if above floor
        if (rig.position.y > 0 || !this.grounded) {
          this.velocity.y += this.data.gravity * dt;
          rig.position.addScaledVector(this.velocity, dt);

          if (rig.position.y <= 0) {
            rig.position.y = 0;
            this.velocity.set(0, 0, 0);
            this.grounded = true;
          }

          this.velocity.x *= 0.94; // Higher friction for better control
          this.velocity.z *= 0.94;
        }
      }
    });
  </script>
</head>

<body>
  <a-scene background="color: #87CEEB" xr-mode-ui="enabled: true" renderer="colorManagement: true">
    
    <a-entity id="rig" position="0 0 0">
      <a-camera id="head" position="0 0 0" look-controls></a-camera>

      <a-entity id="l-ctrl" tracked-controls="hand: left"></a-entity>
      <a-entity id="r-ctrl" tracked-controls="hand: right"></a-entity>

      <a-sphere radius="0.06" color="#FFD7B5" 
                hand-follow="target: #l-ctrl" 
                gorilla-physics="rig: #rig"></a-sphere>

      <a-sphere radius="0.06" color="#FFD7B5" 
                hand-follow="target: #r-ctrl" 
                gorilla-physics="rig: #rig"></a-sphere>
    </a-entity>

    <a-sky id="sky" color="#87CEEB"></a-sky>
    
    <a-plane class="climbable" rotation="-90 0 0" width="100" height="100" color="#3A5F0B"></a-plane>

    <a-box class="climbable" position="2 0.5 -3" color="#777"></a-box>
    <a-box class="climbable" position="-2 1 -5" width="2" height="2" depth="2" color="#444"></a-box>

    <a-sphere class="climbable" position="0 0.5 -8" radius="0.4" color="#00FFFF"
              onclick="document.querySelector('#rig').object3D.position.set(0,0,0)"></a-sphere>

  </a-scene>
</body>
</html>
