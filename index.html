<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gorilla Physics - Single File</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
  /* =========================================================
     HAND FOLLOW (Smooth + Arm Length Limit)
     ========================================================= */
  AFRAME.registerComponent('hand-follow', {
    schema: {
      target: { type: 'selector' },
      rig: { type: 'selector' },
      maxLength: { default: 0.8 },
      smooth: { default: 0.4 }
    },

    init: function () {
      this.tmpVec = new THREE.Vector3();
    },

    tick: function () {
      if (!this.data.target || !this.data.rig) return;

      const hand = this.el.object3D;
      const target = this.data.target.object3D;
      const rigPos = this.data.rig.object3D.position;

      this.tmpVec.copy(target.position);

      const offset = this.tmpVec.clone().sub(rigPos);
      if (offset.length() > this.data.maxLength) {
        offset.setLength(this.data.maxLength);
        this.tmpVec.copy(rigPos).add(offset);
      }

      hand.position.lerp(this.tmpVec, this.data.smooth);
      hand.quaternion.slerp(target.quaternion, this.data.smooth);
    }
  });

  /* =========================================================
     GORILLA PHYSICS (Minimal Fix Version)
     ========================================================= */
  AFRAME.registerComponent('gorilla-physics', {
    schema: {
      rig: { type: 'selector' },
      strength: { default: 1.8 },
      gravity: { default: -16 },
      maxVel: { default: 8 }
    },

    init: function () {
      this.vel = new THREE.Vector3();
      this.prev = new THREE.Vector3();
      this.curr = new THREE.Vector3();
      this.handVel = new THREE.Vector3();
      this.cooldown = 0;

      this.raycaster = new THREE.Raycaster();
      this.surfaces = [];

      this.el.sceneEl.addEventListener('loaded', () => {
        this.surfaces = [...this.el.sceneEl.querySelectorAll('.climbable')]
          .map(e => e.object3D);

        if (this.data.rig)
          this.data.rig.object3D.position.y = 2; // spawn above ground
      });
    },

    tick: function (t, dtMs) {
      if (!dtMs || !this.data.rig) return;

      const dt = dtMs / 1000;
      const rig = this.data.rig.object3D;

      if (this.cooldown > 0) this.cooldown -= dt;

      // Hand velocity
      this.el.object3D.getWorldPosition(this.curr);
      this.handVel.copy(this.curr).sub(this.prev).divideScalar(dt);
      this.prev.copy(this.curr);

      // Remove tiny jitter
      if (this.handVel.lengthSq() < 0.0004)
        this.handVel.set(0, 0, 0);

      // Subtract rig movement
      this.handVel.sub(this.vel);

      // Raycast direction
      let dir = this.handVel.clone().normalize();
      if (dir.lengthSq() < 0.1) dir.set(0, -1, 0);
      this.raycaster.set(this.curr, dir);

      const hits = this.raycaster.intersectObjects(this.surfaces, true);

      // Push-off
      if (hits.length &&
          hits[0].distance < 0.18 &&
          this.handVel.length() > 0.4 &&
          this.cooldown <= 0) {

        this.vel.addScaledVector(this.handVel, -this.data.strength);
        this.vel.clampScalar(-this.data.maxVel, this.data.maxVel);

        this.cooldown = 0.15;

        const gp = this.el.components['tracked-controls']?.controller;
        gp?.hapticActuators?.[0]?.pulse(0.5, 40);
      }

      // Apply physics
      this.vel.y += this.data.gravity * dt;
      rig.position.addScaledVector(this.vel, dt);

      // Floor collision
      if (rig.position.y < 0.01) {
        rig.position.y = 0.01;
        this.vel.y = 0;
        this.vel.x *= 0.85;
        this.vel.z *= 0.85;
      }

      // Air friction
      this.vel.x *= 0.94;
      this.vel.z *= 0.94;
    }
  });
  </script>
</head>

<body>
  <a-scene background="color: #87CEEB">

    <!-- PLAYER RIG (falls with gravity) -->
    <a-entity id="rig" position="0 2 0">

      <!-- HEAD (camera stays 1.6m above rig) -->
      <a-entity id="head" position="0 1.6 0">
        <a-camera></a-camera>
      </a-entity>

      <!-- VR Controllers -->
      <a-entity id="lc" tracked-controls="hand: left"></a-entity>
      <a-entity id="rc" tracked-controls="hand: right"></a-entity>

      <!-- Hands -->
      <a-sphere radius="0.06" color="#222"
        hand-follow="target:#lc; rig:#rig"
        gorilla-physics="rig:#rig">
      </a-sphere>

      <a-sphere radius="0.06" color="#222"
        hand-follow="target:#rc; rig:#rig"
        gorilla-physics="rig:#rig">
      </a-sphere>

    </a-entity>

    <!-- WORLD -->
    <a-plane class="climbable" rotation="-90 0 0" width="100" height="100" color="#3A5F0B"></a-plane>

    <a-box class="climbable" position="2 0.5 -3" depth="1" height="1" width="1" color="#777"></a-box>
    <a-box class="climbable" position="-2 1 -4" depth="1" height="2" width="1" color="#555"></a-box>

  </a-scene>
</body>
</html>
