<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pixel Company</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <!-- THREE is already included by A-Frame, but we use it explicitly -->
</head>

<body>

<!-- ========================================================= -->
<!-- ========================= SCENE ========================= -->
<!-- ========================================================= -->

<a-scene
  background="color: #87a9c4"
  renderer="antialias: true"
  vr-mode-ui="enabled: true">

  <!-- ======================================================= -->
  <!-- ===================== PLAYER RIG ====================== -->
  <!-- ======================================================= -->

  <a-entity id="rig" position="0 1.6 6">

    <!-- CAMERA -->
    <a-camera></a-camera>

    <!-- ================= LEFT CONTROLLER ================= -->
    <a-entity
      id="leftController"
      laser-controls="hand: left"
      visible="false"
      gorilla-movement="rig: #rig">
    </a-entity>

    <!-- LEFT HAND (SMOOTH 3-FINGER) -->
    <a-entity id="leftHand">
      <a-sphere radius="0.045" color="#f2c9a5"></a-sphere>
      <a-sphere position="-0.03 0.03 0.02" radius="0.02" color="#f2c9a5"></a-sphere>
      <a-sphere position="0 0.035 0.025" radius="0.02" color="#f2c9a5"></a-sphere>
      <a-sphere position="0.03 0.03 0.02" radius="0.02" color="#f2c9a5"></a-sphere>
    </a-entity>

    <!-- ================= RIGHT CONTROLLER ================= -->
    <a-entity
      id="rightController"
      laser-controls="hand: right"
      visible="false"
      gorilla-movement="rig: #rig">
    </a-entity>

    <!-- RIGHT HAND -->
    <a-entity id="rightHand">
      <a-sphere radius="0.045" color="#f2c9a5"></a-sphere>
      <a-sphere position="-0.03 0.03 0.02" radius="0.02" color="#f2c9a5"></a-sphere>
      <a-sphere position="0 0.035 0.025" radius="0.02" color="#f2c9a5"></a-sphere>
      <a-sphere position="0.03 0.03 0.02" radius="0.02" color="#f2c9a5"></a-sphere>
    </a-entity>

  </a-entity>

  <!-- ======================================================= -->
  <!-- ======================= WORLD ========================= -->
  <!-- ======================================================= -->

  <!-- GROUND -->
  <a-plane
    rotation="-90 0 0"
    width="200"
    height="200"
    color="#4c7a3d">
  </a-plane>

  <!-- SPAWN BUILDING -->
  <a-box position="0 1 -4" width="6" height="2" depth="6" color="#888"></a-box>

  <!-- ====================== MINES ========================== -->

  <a-box id="mineEntrance" position="12 1 -12" width="4" height="3" depth="4" color="#333"></a-box>

  <a-box position="12 1 -18" width="6" height="3" depth="12" color="#222"></a-box>

  <a-light id="mineLight" type="ambient" intensity="0"></a-light>

  <!-- EXIT ORE -->
  <a-sphere id="exitOre" position="12 1 -22" radius="0.5" color="#00ffff"></a-sphere>

</a-scene>

<!-- ========================================================= -->
<!-- ===================== GAME LOGIC ======================== -->
<!-- ========================================================= -->

<script>
/* =========================================================
   HAND FOLLOW (CONTROLLER â†’ HAND MESH)
========================================================= */

AFRAME.registerComponent('hand-follow', {
  schema: { controller: {type: 'selector'} },
  tick: function () {
    if (!this.data.controller) return;
    this.el.object3D.position.copy(this.data.controller.object3D.position);
    this.el.object3D.quaternion.copy(this.data.controller.object3D.quaternion);
  }
});

document.getElementById('leftHand')
  .setAttribute('hand-follow', { controller: '#leftController' });

document.getElementById('rightHand')
  .setAttribute('hand-follow', { controller: '#rightController' });

/* =========================================================
   GORILLA MOVEMENT (BASED ON YOUR CODE)
========================================================= */

AFRAME.registerComponent('gorilla-movement', {
  schema: {
    speed: { type: 'number', default: 2.0 },
    rig: { type: 'selector' }
  },

  init: function () {
    this.prev = new THREE.Vector3();
    this.curr = new THREE.Vector3();
    this.delta = new THREE.Vector3();
  },

  tick: function () {
    if (!this.data.rig) return;

    // Track controller movement
    this.el.object3D.getWorldPosition(this.curr);
    this.delta.copy(this.curr).sub(this.prev);

    // Ground check (simple but stable)
    const rigPos = this.data.rig.object3D.position;
    const grounded = rigPos.y <= 1.6;

    if (grounded) {
      // Push opposite to hand movement
      rigPos.x -= this.delta.x * this.data.speed;
      rigPos.z -= this.delta.z * this.data.speed;
    }

    // Gravity clamp
    rigPos.y = 1.6;

    // Save for next frame
    this.prev.copy(this.curr);
  }
});

/* =========================================================
   MINE DARKNESS
========================================================= */

AFRAME.registerComponent('mine-zone', {
  tick: function () {
    const rig = document.getElementById('rig');
    const light = document.getElementById('mineLight');
    if (!rig) return;

    if (rig.object3D.position.z < -14) {
      light.setAttribute('intensity', 0.2);
    } else {
      light.setAttribute('intensity', 0);
    }
  }
});

document.querySelector('a-scene').setAttribute('mine-zone', '');

/* =========================================================
   EXIT ORE TELEPORT
========================================================= */

document.getElementById('exitOre').addEventListener('click', () => {
  document.getElementById('rig').setAttribute('position', '0 1.6 6');
});
</script>

</body>
</html>
