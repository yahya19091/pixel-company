<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pixel Company â€“ Gorilla Prototype</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>

  <!-- CAMERA OFFSET (respects boundary floor) -->
  <script>
  AFRAME.registerComponent('camera-offset', {
    schema: { height: { default: 0 } }, // 0 = boundary floor correct
    tick() {
      this.el.object3D.position.y = this.data.height;
    }
  });
  </script>

  <!-- SNAP TURN (always on) -->
  <script>
  AFRAME.registerComponent('snap-turn', {
    schema: { angle: { default: 45 }, deadzone: { default: 0.7 }, cooldown: { default: 250 } },
    init() { this.ready = true; },
    tick() {
      const s = this.el.sceneEl.renderer.xr.getSession();
      if (!s || !this.ready) return;

      for (const src of s.inputSources) {
        if (src.handedness !== 'right' || !src.gamepad) continue;
        const x = src.gamepad.axes[2] ?? src.gamepad.axes[0];
        if (Math.abs(x) > this.data.deadzone) {
          this.el.object3D.rotation.y += THREE.MathUtils.degToRad(
            this.data.angle * (x > 0 ? -1 : 1)
          );
          this.ready = false;
          setTimeout(() => this.ready = true, this.data.cooldown);
          break;
        }
      }
    }
  });
  </script>

  <!-- HAND FOLLOW -->
  <script>
  AFRAME.registerComponent('hand-follow', {
    schema: { target: { type: 'selector' } },
    tick() {
      if (!this.data.target) return;
      this.el.object3D.position.copy(this.data.target.object3D.position);
      this.el.object3D.quaternion.copy(this.data.target.object3D.quaternion);
    }
  });
  </script>

  <!-- FINGER CURL (Quest trigger + grip) -->
  <script>
  AFRAME.registerComponent('finger-curl', {
    schema: { hand: { default: 'left' } },
    init() {
      this.curl = 0;
    },
    tick() {
      const pads = navigator.getGamepads();
      const gp = [...pads].find(p =>
        p && p.hand === this.data.hand
      );
      if (!gp) return;

      const trigger = gp.buttons[0]?.value || 0;
      const grip = gp.buttons[1]?.value || 0;

      this.curl += ((trigger + grip) / 2 - this.curl) * 0.25;

      this.el.object3D.rotation.x = -this.curl * 1.2;
    }
  });
  </script>

  <!-- GORILLA PHYSICS -->
  <script>
  AFRAME.registerComponent('gorilla-physics', {
    schema: { strength:{default:2.2}, gravity:{default:-18}, maxSpeed:{default:15} },
    init() {
      this.vel = new THREE.Vector3();
      this.prevL = new THREE.Vector3();
      this.prevR = new THREE.Vector3();
      this.ray = new THREE.Raycaster();
      this.tmp = new THREE.Vector3();
      this.surfaces = [];
      this.el.sceneEl.addEventListener('loaded', () => {
        this.surfaces = [...this.el.sceneEl.querySelectorAll('.climbable')]
          .map(e => e.object3D);
      });
    },
    tick(_, dtMs) {
      if (!dtMs) return;
      const dt = Math.min(dtMs / 1000, 0.033);
      const rig = this.el.object3D;

      const handStep = (id, prev) => {
        const h = document.querySelector(id);
        if (!h) return;
        const p = h.object3D.position.clone();
        const v = p.clone().sub(prev).divideScalar(dt);
        if (v.lengthSq() < 0.0004) { prev.copy(p); return; }

        h.object3D.getWorldPosition(this.tmp);
        this.ray.set(this.tmp, v.clone().normalize());
        const hit = this.ray.intersectObjects(this.surfaces,true)[0];
        if (hit && hit.distance < 0.18) {
          v.applyQuaternion(rig.quaternion);
          this.vel.copy(v).multiplyScalar(-this.data.strength);
          this.vel.clampLength(0, this.data.maxSpeed);
        }
        prev.copy(p);
      };

      handStep('#leftHand', this.prevL);
      handStep('#rightHand', this.prevR);

      this.vel.y += this.data.gravity * dt;
      rig.position.addScaledVector(this.vel, dt);

      if (rig.position.y < 0) {
        rig.position.y = 0;
        this.vel.y = 0;
      }
    }
  });
  </script>
</head>

<body>
<a-scene background="color:#050505"
         networked-scene="app:gorilla;room:room1;adapter:webrtc">

<a-assets>
  <template id="avatar-template">
    <a-entity>
      <a-sphere radius="0.35" color="#222"></a-sphere>
      <a-entity class="left-hand-sync"></a-entity>
      <a-entity class="right-hand-sync"></a-entity>
    </a-entity>
  </template>
</a-assets>

<a-entity id="rig"
          snap-turn
          gorilla-physics
          networked="template:#avatar-template;attachTemplateToLocal:false">

  <a-entity camera-offset>
    <a-camera></a-camera>
  </a-entity>

  <a-entity id="lc" tracked-controls="hand:left"></a-entity>
  <a-entity id="rc" tracked-controls="hand:right"></a-entity>

  <!-- LEFT HAND -->
  <a-entity id="leftHand" class="left-hand-sync"
            hand-follow="target:#lc">
    <a-sphere radius="0.05" color="#ddd"></a-sphere>
    <a-entity position="0 0 -0.05" finger-curl="hand:left">
      <a-box width="0.02" height="0.08" depth="0.02" color="#ccc"></a-box>
    </a-entity>
  </a-entity>

  <!-- RIGHT HAND -->
  <a-entity id="rightHand" class="right-hand-sync"
            hand-follow="target:#rc">
    <a-sphere radius="0.05" color="#ddd"></a-sphere>
    <a-entity position="0 0 -0.05" finger-curl="hand:right">
      <a-box width="0.02" height="0.08" depth="0.02" color="#ccc"></a-box>
    </a-entity>
  </a-entity>

</a-entity>

<a-grid class="climbable"></a-grid>
<a-box class="climbable" position="0 2 -4" width="4" height="4" depth="0.5"></a-box>

<a-light type="ambient" intensity="0.4"></a-light>
<a-light type="directional" position="1 2 1" intensity="0.8"></a-light>

</a-scene>
</body>
</html>
