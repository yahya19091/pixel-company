<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pixel Company VR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<script>
/**********************
 PLAYER STATE
**********************/
const Player={coins:Number(localStorage.getItem('pc_coins'))||0,tool:null,durability:0,health:100,inMine:false,mineTimer:0,hunterSpawned:false};
function saveGame(){localStorage.setItem('pc_coins',Player.coins);}

/**********************
 SAFE MONKEY MOVEMENT (QUEST FIXED)
**********************/
AFRAME.registerComponent('monkey-move',{
  schema:{speed:{default:0.06}},
  init(){this.vel=new THREE.Vector3();},
  tick(){
    const pads=navigator.getGamepads();
    let forward=0;
    for(const p of pads){ if(!p) continue; forward+=Math.abs(p.axes[3]||0); }
    if(forward>0.15){
      const d=new THREE.Vector3();
      this.el.object3D.getWorldDirection(d);
      d.y=0; d.normalize();
      this.vel.add(d.multiplyScalar(forward*this.data.speed));
    }
    this.vel.multiplyScalar(0.85);
    this.el.object3D.position.add(this.vel);
    if(this.el.object3D.position.y<1.6) this.el.object3D.position.y=1.6;
  }
});

/**********************
 UI
**********************/
function updateUI(){coinText.setAttribute('value',`Coins: ${Player.coins}`);toolText.setAttribute('value',Player.tool?`${Player.tool} (${Player.durability})`:'No tool');healthText.setAttribute('value',`HP: ${Player.health}`);saveGame();}

/**********************
 SHOP
**********************/
AFRAME.registerComponent('shop-item',{schema:{tool:{type:'string'},price:{type:'int'},durability:{type:'int'}},init(){this.el.addEventListener('click',()=>{if(Player.coins<this.data.price)return;Player.coins-=this.data.price;Player.tool=this.data.tool;Player.durability=this.data.durability;updateUI();});}});

/**********************
 CRYSTALS
**********************/
AFRAME.registerComponent('crystal',{init(){this.el.addEventListener('click',()=>{if(!Player.tool)return;Player.durability--;Player.coins+=Player.tool==='pickaxe'?6:2;if(Player.durability<=0)Player.tool=null;updateUI();this.el.remove();});}});

/**********************
 EXIT ORE
**********************/
AFRAME.registerComponent('exit-ore',{init(){this.el.addEventListener('click',()=>{if(!Player.tool)return;const rig=document.querySelector('#rig');rig.object3D.position.set(0,1.6,0);sky.setAttribute('color','#87ceeb');sun.setAttribute('intensity','1.2');amb.setAttribute('intensity','0.35');alert('Escaped the mines');});}});

/**********************
 MINE LIGHTING
**********************/
AFRAME.registerComponent('mine-check',{tick(){const z=this.el.object3D.position.z;if(z<-18){sky.setAttribute('color','#020202');sun.setAttribute('intensity','0.05');amb.setAttribute('intensity','0.05');}else{sky.setAttribute('color','#87ceeb');sun.setAttribute('intensity','1.2');amb.setAttribute('intensity','0.35');}}});
</script>
</head>

<body>
<a-scene>

<a-light id="sun" type="directional" intensity="1.2" position="5 10 5"></a-light>
<a-light id="amb" type="ambient" intensity="0.35"></a-light>

<a-entity id="rig" position="0 1.6 0" monkey-move mine-check>
  <a-camera></a-camera>

  <!-- HANDS FIXED -->
  <a-entity laser-controls="hand: left"></a-entity>
  <a-entity laser-controls="hand: right"></a-entity>

  <a-text id="coinText" position="0 -0.3 -0.6" width="2" align="center"></a-text>
  <a-text id="toolText" position="0 -0.45 -0.6" width="2" align="center"></a-text>
  <a-text id="healthText" position="0 -0.6 -0.6" width="2" align="center"></a-text>
</a-entity>

<a-sky id="sky" color="#87ceeb"></a-sky>
<a-plane rotation="-90 0 0" width="200" height="200" color="#6fdc6f"></a-plane>

<!-- SHOP -->
<a-entity position="6 0 -6">
  <a-box width="4" height="3" depth="4" color="#ffaa66"></a-box>
  <a-box position="-1 1 2.2" color="#8b5a2b" shop-item="tool: twig; price: 0; durability: 10"></a-box>
  <a-box position="0 1 2.2" color="#999" shop-item="tool: pickaxe; price: 100; durability: 999"></a-box>
</a-entity>

<!-- MINE -->
<a-box position="0 1 -20" depth="6" height="6" width="6" color="#333"></a-box>
<a-sphere crystal position="0 1 -40" radius="0.3" color="#55ffff"></a-sphere>
<a-sphere exit-ore position="2 1 -55" radius="0.45" color="#ff44ff"></a-sphere>

</a-scene>
<script>updateUI();</script>
</body>
</html>
