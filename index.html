<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Pixel Company â€“ Gorilla Prototype</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>

<script>
/* =========================================================
   SNAP TURN (Right Joystick)
========================================================= */
AFRAME.registerComponent('snap-turn', {
  init() {
    this.cooldown = false;
  },
  tick() {
    // Gamepad 1 is usually the Right Controller
    const gp = navigator.getGamepads()[1] || navigator.getGamepads()[0];
    if (!gp || this.cooldown) return;

    // Axis 2 is usually the horizontal stick on Quest
    const xAxis = gp.axes[2] || gp.axes[0]; 

    if (Math.abs(xAxis) > 0.7) {
      this.el.object3D.rotation.y -= Math.sign(xAxis) * THREE.MathUtils.degToRad(30);
      
      this.cooldown = true;
      setTimeout(() => this.cooldown = false, 250); // 1/4 second delay
    }
  }
});

/* =========================================================
   HAND FOLLOW (Fixed Local Tracking)
========================================================= */
AFRAME.registerComponent('hand-follow', {
  schema: { target: { type: 'selector' } },
  tick() {
    if (!this.data.target) return;
    const hand = this.el.object3D;
    const controller = this.data.target.object3D;

    // We copy LOCAL position. Since hand and controller are both 
    // inside the #rig, they stay perfectly aligned.
    hand.position.copy(controller.position);
    hand.quaternion.copy(controller.quaternion);
  }
});

/* =========================================================
   FINGER CURL (Trigger + Grip)
========================================================= */
AFRAME.registerComponent('finger-curl', {
  schema: { hand: { default: 0 } }, 
  tick() {
    const gp = navigator.getGamepads()[this.data.hand];
    if (!gp) return;

    const trigger = gp.buttons[0]?.value || 0;
    const grip = gp.buttons[1]?.value || 0;

    this.el.object3D.children.forEach((finger, i) => {
      let curl = grip;
      if (i === 1) curl = Math.max(trigger, grip); // index finger
      finger.rotation.x = -curl * 1.2;
    });
  }
});

/* =========================================================
   GORILLA PHYSICS (Rig-Based)
========================================================= */
AFRAME.registerComponent('gorilla-physics', {
  schema: {
    strength: { default: 1.8 },
    gravity: { default: -18 }
  },
  init() {
    this.vel = new THREE.Vector3();
    this.prevL = new THREE.Vector3();
    this.prevR = new THREE.Vector3();
    this.worldPos = new THREE.Vector3();
    this.ray = new THREE.Raycaster();
  },
  tick(_, dtMs) {
    if (!dtMs) return;
    const dt = Math.min(dtMs / 1000, 0.033);
    const rig = this.el.object3D;
    const surfaces = [...this.el.sceneEl.querySelectorAll('.climbable')].map(e => e.object3D);

    const processHand = (id, prevPos) => {
      const hand = document.querySelector(id);
      if (!hand) return;

      const currPos = hand.object3D.position;
      const handVel = currPos.clone().sub(prevPos).divideScalar(dt);
      
      // We need world position for the floor-hit raycast
      hand.object3D.getWorldPosition(this.worldPos);
      this.ray.set(this.worldPos, new THREE.Vector3(0, -1, 0));
      const hits = this.ray.intersectObjects(surfaces, true);

      if (hits.length && hits[0].distance < 0.15 && handVel.y < -0.2) {
        this.vel.x = -handVel.x * this.data.strength;
        this.vel.z = -handVel.z * this.data.strength;
        this.vel.y = -handVel.y * (this.data.strength * 1.4);
      }
      prevPos.copy(currPos);
    };

    processHand('#leftHand', this.prevL);
    processHand('#rightHand', this.prevR);

    // Gravity
    this.vel.y += this.data.gravity * dt;
    rig.position.addScaledVector(this.vel, dt);

    // Grounding (Rig hits floor)
    if (rig.position.y <= 0) {
      rig.position.y = 0;
      if (this.vel.y < 0) this.vel.y = 0;
      this.vel.x *= 0.8;
      this.vel.z *= 0.8;
    }
  }
});
</script>
</head>

<body>
<a-scene background="color: #87CEEB">

  <a-entity id="rig" position="0 3 0" snap-turn gorilla-physics>
    
    <a-camera look-controls></a-camera>

    <a-entity id="lc" tracked-controls="hand:left"></a-entity>
    <a-entity id="rc" tracked-controls="hand:right"></a-entity>

    <a-entity id="leftHand" hand-follow="target:#lc" finger-curl="hand:0">
      <a-box width="0.08" height="0.04" depth="0.08" color="#eee"></a-box>
      <a-box position="0.02 0 -0.04" width="0.02" height="0.02" depth="0.06"></a-box>
      <a-box position="0 0 -0.05" width="0.02" height="0.02" depth="0.07"></a-box>
      <a-box position="-0.02 0 -0.04" width="0.02" height="0.02" depth="0.06"></a-box>
    </a-entity>

    <a-entity id="rightHand" hand-follow="target:#rc" finger-curl="hand:1">
      <a-box width="0.08" height="0.04" depth="0.08" color="#eee"></a-box>
      <a-box position="0.02 0 -0.04" width="0.02" height="0.02" depth="0.06"></a-box>
      <a-box position="0 0 -0.05" width="0.02" height="0.02" depth="0.07"></a-box>
      <a-box position="-0.02 0 -0.04" width="0.02" height="0.02" depth="0.06"></a-box>
    </a-entity>

    <a-sphere position="0 0.5 0" radius="0.4" color="#444"></a-sphere>

  </a-entity>

  <a-plane class="climbable" rotation="-90 0 0" width="100" height="100" color="#3A5F0B"></a-plane>
  <a-box class="climbable" position="2 0.5 -3" color="#777"></a-box>

</a-scene>
</body>
</html>
