<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pixel Company â€“ VR</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Networked A-Frame (HTTPS-safe) -->
  <script src="https://unpkg.com/networked-aframe@0.10.1/dist/networked-aframe.min.js"></script>

  <!-- ================= STATUS TEXT (DEBUG, SAFE) ================= -->
  <script>
    window.addEventListener("load", () => {
      console.log("INDEX.HTML LOADED OK");
    });
  </script>

  <!-- ================= NAME TAG ================= -->
  <script>
  AFRAME.registerComponent("name-tag", {
    init() {
      const label = document.createElement("a-entity");
      label.setAttribute("text", {
        value: "Player",
        align: "center",
        color: "#fff",
        width: 2
      });
      label.setAttribute("position", "0 0.35 0");
      label.setAttribute("billboard", "");
      this.el.appendChild(label);

      setTimeout(() => {
        if (window.NAF && NAF.connection?.adapter?.myId) {
          label.setAttribute("text", "value", NAF.connection.adapter.myId);
        }
      }, 1500);
    }
  });
  </script>

  <!-- ================= HAND FOLLOW ================= -->
  <script>
  AFRAME.registerComponent('hand-follow',{
    schema:{target:{type:'selector'}},
    tick(){
      if(!this.data.target) return;
      this.el.object3D.position.copy(this.data.target.object3D.position);
      this.el.object3D.quaternion.copy(this.data.target.object3D.quaternion);
    }
  });
  </script>

  <!-- ================= SNAP TURN ================= -->
  <script>
  AFRAME.registerComponent('snap-turn', {
    schema:{angle:{default:45}, deadzone:{default:0.7}, cooldown:{default:250}},
    init(){ this.canSnap = true; },
    tick(){
      const xr = this.el.sceneEl.renderer?.xr;
      if(!xr || !xr.getSession || !this.canSnap) return;

      const session = xr.getSession();
      if(!session) return;

      for(const src of session.inputSources){
        if(src.handedness!=='right' || !src.gamepad) continue;
        const x = src.gamepad.axes[2] ?? src.gamepad.axes[0];
        if(Math.abs(x) > this.data.deadzone){
          const dir = x > 0 ? -1 : 1;
          this.el.object3D.rotation.y +=
            (this.data.angle * dir) * (Math.PI/180);
          this.canSnap = false;
          setTimeout(()=>this.canSnap=true, this.data.cooldown);
          break;
        }
      }
    }
  });
  </script>

  <!-- ================= GORILLA PHYSICS (UNCHANGED) ================= -->
  <script>
  AFRAME.registerComponent('gorilla-physics',{
    schema:{strength:{default:2.0}, gravity:{default:-20}},
    init(){
      this.vel=new THREE.Vector3();
      this.prevL=new THREE.Vector3();
      this.prevR=new THREE.Vector3();
      this.worldPos=new THREE.Vector3();
      this.ray=new THREE.Raycaster();
    },
    tick(_,dtMs){
      if(!dtMs) return;
      const dt=Math.min(dtMs/1000,0.033);
      const rig=this.el.object3D;
      const surfaces=[...this.el.sceneEl.querySelectorAll('.climbable')]
        .map(e=>e.object3D);

      const processHand=(id,prevPos)=>{
        const hand=document.querySelector(id);
        if(!hand) return;

        const curr=hand.object3D.position;
        const vel=curr.clone().sub(prevPos).divideScalar(dt);

        hand.object3D.getWorldPosition(this.worldPos);
        this.ray.set(this.worldPos,new THREE.Vector3(0,-1,0));
        const hits=this.ray.intersectObjects(surfaces,true);

        if(hits.length && hits[0].distance<0.18 && vel.y<-0.2){
          const wv=vel.clone().applyQuaternion(rig.quaternion);
          this.vel.x=-wv.x*this.data.strength;
          this.vel.z=-wv.z*this.data.strength;
          this.vel.y=-wv.y*(this.data.strength*1.5);
        }
        prevPos.copy(curr);
      };

      processHand('#leftHand',this.prevL);
      processHand('#rightHand',this.prevR);

      this.vel.y+=this.data.gravity*dt;
      rig.position.addScaledVector(this.vel,dt);

      if(rig.position.y<=0){
        rig.position.y=0;
        if(this.vel.y<0) this.vel.y=0;
        this.vel.x*=0.75;
        this.vel.z*=0.75;
      }
    }
  });
  </script>
</head>

<body>
  <a-scene
    background="color:#111"
    networked-scene="app:gorilla; room:room1; adapter:webrtc">

    <!-- ASSETS -->
    <a-assets>
      <a-template id="head-template">
        <a-sphere radius="0.2" color="#44ff44"></a-sphere>
      </a-template>
      <a-template id="hand-template">
        <a-box width="0.1" height="0.1" depth="0.1" color="#44ff44"></a-box>
      </a-template>
    </a-assets>

    <!-- SKY + LIGHT -->
    <a-sky color="#0a0a33"></a-sky>
    <a-entity light="type:ambient; intensity:0.6"></a-entity>

    <!-- PLAYER -->
    <a-entity id="rig" snap-turn gorilla-physics>

      <a-entity id="head"
        networked="template:#head-template; attachTemplateToLocal:false"
        position="0 1.6 0"
        name-tag>
      </a-entity>

      <a-camera position="0 1.6 0"></a-camera>

      <a-entity id="lc" oculus-touch-controls="hand:left"></a-entity>
      <a-entity id="rc" oculus-touch-controls="hand:right"></a-entity>

      <a-entity id="leftHand"
        hand-follow="target:#lc"
        networked="template:#hand-template; attachTemplateToLocal:false">
      </a-entity>

      <a-entity id="rightHand"
        hand-follow="target:#rc"
        networked="template:#hand-template; attachTemplateToLocal:false">
      </a-entity>

    </a-entity>

    <!-- WORLD -->
    <a-plane class="climbable" rotation="-90 0 0"
             width="100" height="100" color="#222"></a-plane>

    <!-- DEBUG CONFIRMATION -->
    <a-text value="LOADED"
            position="0 2 -2"
            align="center"
            color="#00ff00"></a-text>

  </a-scene>
</body>
</html>
