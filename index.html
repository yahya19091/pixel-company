<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8">
  <title>Pixel Company – VR Prototype</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- Multiplayer -->
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>

  <script>
  /* =========================================================
     PICKUP SYSTEM
  ========================================================= */
  AFRAME.registerComponent("pickup", {
    init: function () {
      this.el.addEventListener("grab-attempt", (e) => {
        const hand = e.detail.hand;

        const handPos = new THREE.Vector3();
        const itemPos = new THREE.Vector3();

        hand.object3D.getWorldPosition(handPos);
        this.el.object3D.getWorldPosition(itemPos);

        if (handPos.distanceTo(itemPos) < 0.35) {
          hand.appendChild(this.el);
          this.el.emit("grab-start", {hand: hand});
        }
      });

      this.el.addEventListener("grab-end", (e) => {
        const hand = e.detail.hand;
        if (hand.contains(this.el)) {
          hand.removeChild(this.el);
        }
      });
    }
  });

  /* =========================================================
     VR GRAB (Trigger grab, B/Y drop)
  ========================================================= */
  AFRAME.registerComponent("vr-grab", {
    schema: { hand: { type: "selector" } },

    init: function () {
      this.grabbing = false;
      this.el.addEventListener("controllerconnected", (evt) => {
        this.gamepad = evt.detail.component.data.gamepad;
      });
    },

    tick: function () {
      if (!this.gamepad) return;

      const triggerPressed = this.gamepad.buttons[0]?.pressed;
      const bPressed = this.gamepad.buttons[1]?.pressed;
      const yPressed = this.gamepad.buttons[3]?.pressed;

      if (triggerPressed && !this.grabbing) {
        this.grabbing = true;
        this.data.hand.emit("grab-attempt", { hand: this.data.hand });
      }

      if (!triggerPressed && this.grabbing) {
        this.grabbing = false;
        this.data.hand.emit("grab-end", { hand: this.data.hand });
      }

      if (bPressed || yPressed) {
        this.data.hand.emit("grab-end", { hand: this.data.hand });
      }
    }
  });

  /* =========================================================
     SNAP-TO-HAND (Align pickaxe correctly)
  ========================================================= */
  AFRAME.registerComponent("snap-to-hand", {
    schema: {
      pos: {type: "vec3", default: {x:0, y:0, z:0}},
      rot: {type: "vec3", default: {x:0, y:0, z:0}}
    },

    init: function () {
      this.el.addEventListener("grab-start", (e) => {
        const hand = e.detail.hand;

        this.el.object3D.position.set(
          this.data.pos.x,
          this.data.pos.y,
          this.data.pos.z
        );

        this.el.object3D.rotation.set(
          THREE.MathUtils.degToRad(this.data.rot.x),
          THREE.MathUtils.degToRad(this.data.rot.y),
          THREE.MathUtils.degToRad(this.data.rot.z)
        );
      });
    }
  });

  /* =========================================================
     HAND FOLLOW (Gorilla Tag style)
  ========================================================= */
  AFRAME.registerComponent('hand-follow',{
    schema:{target:{type:'selector'}},
    tick(){
      if(!this.data.target) return;
      this.el.object3D.position.copy(this.data.target.object3D.position);
      this.el.object3D.quaternion.copy(this.data.target.object3D.quaternion);
    }
  });
  </script>
</head>

<body>
  <a-scene background="color:#111">

    <!-- Player -->
    <a-entity id="rig" position="0 1.6 0">

      <a-camera></a-camera>

      <!-- Raw controller tracking -->
      <a-entity id="lc" tracked-controls="hand:left"></a-entity>
      <a-entity id="rc" tracked-controls="hand:right"></a-entity>

      <!-- Gorilla Tag–style hands -->
      <a-entity id="leftHand" hand-follow="target:#lc" vr-grab="hand:#leftHand">
        <a-box width="0.18" height="0.06" depth="0.28" color="#ccc"></a-box>
        <a-sphere radius="0.15" visible="false" class="grab-zone"></a-sphere>
      </a-entity>

      <a-entity id="rightHand" hand-follow="target:#rc" vr-grab="hand:#rightHand">
        <a-box width="0.18" height="0.06" depth="0.28" color="#ccc"></a-box>
        <a-sphere radius="0.15" visible="false" class="grab-zone"></a-sphere>
      </a-entity>

    </a-entity>

    <!-- Ground -->
    <a-plane rotation="-90 0 0" width="100" height="100" color="#222"></a-plane>

    <!-- Pickaxe (scaled + lifted + snap-to-hand) -->
    <a-entity id="pickaxe"
              gltf-model="url(pickaxe.glb)"
              position="0 0.6 -2"
              rotation="0 45 0"
              scale="0.08 0.08 0.08"
              pickup
              snap-to-hand="pos: 0.05 -0.05 -0.15; rot: 0 90 -90">
    </a-entity>

  </a-scene>
</body>
</html>
