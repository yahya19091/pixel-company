<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8">
  <title>Pixel Company â€“ Full VR Game</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Networked-Aframe -->
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>

  <!-- ===== GLOBAL SYNCED MUSIC ===== -->
  <script>
  AFRAME.registerComponent("synced-music", {
    init: function () {
      this.sound = this.el.components.sound;
      this.audio = this.sound.pool.children[0];
      this.currentVolume = 0;
      this.targetVolume = 0.4;
      this.fadeSpeed = 0.005;
      this.isMuted = false;
      this.isHost = false;
      this.lastSync = 0;

      this.sound.setVolume(0);
      this.sound.playSound();

      setInterval(() => {
        if (!this.isMuted && this.currentVolume < this.targetVolume) {
          this.currentVolume += this.fadeSpeed;
          this.sound.setVolume(this.currentVolume);
        }
      }, 50);

      window.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() === "x") {
          this.isMuted = !this.isMuted;
          this.sound.setVolume(this.isMuted ? 0 : this.currentVolume);
        }
      });

      NAF.connection.subscribeToDataChannel("musicTime", (sender, type, data) => {
        if (!this.isHost) this.audio.currentTime = data.t;
      });

      setTimeout(() => {
        this.isHost =
          NAF.connection.isConnected() &&
          NAF.connection.adapter.myId === NAF.connection.adapter.getRoomOwner();
      }, 2000);
    },

    tick: function (t) {
      if (!this.isHost) return;
      if (t - this.lastSync > 1000) {
        this.lastSync = t;
        NAF.connection.broadcastData("musicTime", { t: this.audio.currentTime });
      }
    }
  });
  </script>

  <!-- ===== DAY/NIGHT CYCLE ===== -->
  <script>
  AFRAME.registerComponent("day-night-cycle", {
    schema: { duration: { default: 600000 } },

    init: function () {
      this.sky = document.querySelector("#sky");
      this.sun = document.querySelector("#sun");
      this.amb = document.querySelector("#ambient");
    },

    tick: function (t) {
      const p = (t % this.data.duration) / this.data.duration;
      const angle = p * 360;
      this.sun.setAttribute("rotation", `${angle} 0 0`);

      let skyColor;
      if (p < 0.25) skyColor = "#0a0a33";
      else if (p < 0.30) skyColor = "#3b4a6b";
      else if (p < 0.70) skyColor = "#87CEEB";
      else if (p < 0.75) skyColor = "#4a3b6b";
      else skyColor = "#0a0a33";

      this.sky.setAttribute("color", skyColor);
      this.amb.setAttribute("intensity", Math.max(0.2, Math.sin(p * Math.PI)));
    }
  });
  </script>

  <!-- ===== SNAP TURN ===== -->
  <script>
  AFRAME.registerComponent('snap-turn', {
    schema: { angle:{default:45}, deadzone:{default:0.7}, cooldown:{default:250} },
    init(){ this.canSnap = true; },
    tick(){
      const session = this.el.sceneEl.renderer.xr.getSession();
      if(!session || !this.canSnap) return;

      for(const source of session.inputSources){
        if(source.handedness!=='right' || !source.gamepad) continue;
        const x = source.gamepad.axes[2] || source.gamepad.axes[0];

        if(Math.abs(x) > this.data.deadzone){
          const dir = x > 0 ? -1 : 1;
          this.el.object3D.rotation.y += (this.data.angle * dir) * (Math.PI/180);

          if(source.gamepad.hapticActuators?.[0])
            source.gamepad.hapticActuators[0].pulse(0.3,100);

          this.canSnap = false;
          setTimeout(()=>this.canSnap=true, this.data.cooldown);
          break;
        }
      }
    }
  });
  </script>

  <!-- ===== HAND FOLLOW ===== -->
  <script>
  AFRAME.registerComponent('hand-follow',{
    schema:{target:{type:'selector'}},
    tick(){
      if(!this.data.target) return;
      this.el.object3D.position.copy(this.data.target.object3D.position);
      this.el.object3D.quaternion.copy(this.data.target.object3D.quaternion);
    }
  });
  </script>

  <!-- ===== GORILLA PHYSICS ===== -->
  <script>
  AFRAME.registerComponent('gorilla-physics',{
    schema:{strength:{default:2.0}, gravity:{default:-20}},
    init(){
      this.vel=new THREE.Vector3();
      this.prevL=new THREE.Vector3();
      this.prevR=new THREE.Vector3();
      this.worldPos=new THREE.Vector3();
      this.ray=new THREE.Raycaster();
    },
    tick(_,dtMs){
      if(!dtMs) return;
      const dt=Math.min(dtMs/1000,0.033);
      const rig=this.el.object3D;
      const surfaces=[...this.el.sceneEl.querySelectorAll('.climbable')].map(e=>e.object3D);

      const processHand=(id,prevPos,gpIdx)=>{
        const hand=document.querySelector(id);
        if(!hand) return;

        const currPos=hand.object3D.position;
        const handVelLocal=currPos.clone().sub(prevPos).divideScalar(dt);

        hand.object3D.getWorldPosition(this.worldPos);
        this.ray.set(this.worldPos,new THREE.Vector3(0,-1,0));
        const hits=this.ray.intersectObjects(surfaces,true);

        if(hits.length && hits[0].distance<0.18 && handVelLocal.y<-0.2){
          const worldVel=handVelLocal.clone().applyQuaternion(rig.quaternion);

          this.vel.x=-worldVel.x*this.data.strength;
          this.vel.z=-worldVel.z*this.data.strength;
          this.vel.y=-worldVel.y*(this.data.strength*1.5);

          const gp=navigator.getGamepads()[gpIdx];
          gp?.hapticActuators?.[0]?.pulse(0.6,50);
        }
        prevPos.copy(currPos);
      };

      processHand('#leftHand',this.prevL,0);
      processHand('#rightHand',this.prevR,1);

      this.vel.y+=this.data.gravity*dt;
      rig.position.addScaledVector(this.vel,dt);

      if(rig.position.y<=0){
        rig.position.y=0;
        if(this.vel.y<0) this.vel.y=0;
        this.vel.x*=0.75;
        this.vel.z*=0.75;
      }
    }
  });
  </script>

  <!-- ===== PICKUP SYSTEM ===== -->
  <script>
  AFRAME.registerComponent("pickup", {
    init: function () {
      this.el.addEventListener("grab-attempt", (e) => {
        const hand = e.detail.hand;

        const handPos = new THREE.Vector3();
        const itemPos = new THREE.Vector3();

        hand.object3D.getWorldPosition(handPos);
        this.el.object3D.getWorldPosition(itemPos);

        if (handPos.distanceTo(itemPos) < 0.35) {
          hand.appendChild(this.el);
          this.el.emit("grab-start", {hand: hand});
        }
      });

      this.el.addEventListener("grab-end", (e) => {
        const hand = e.detail.hand;
        if (hand.contains(this.el)) {
          hand.removeChild(this.el);
        }
      });
    }
  });
  </script>

  <!-- ===== VR GRAB ===== -->
  <script>
  AFRAME.registerComponent("vr-grab", {
    schema: { hand: { type: "selector" } },

    init: function () {
      this.grabbing = false;
      this.el.addEventListener("controllerconnected", (evt) => {
        this.gamepad = evt.detail.component.data.gamepad;
      });
    },

    tick: function () {
      if (!this.gamepad) return;

      const triggerPressed = this.gamepad.buttons[0]?.pressed;
      const bPressed = this.gamepad.buttons[1]?.pressed;
      const yPressed = this.gamepad.buttons[3]?.pressed;

      if (triggerPressed && !this.grabbing) {
        this.grabbing = true;
        this.data.hand.emit("grab-attempt", { hand: this.data.hand });
      }

      if (!triggerPressed && this.grabbing) {
        this.grabbing = false;
        this.data.hand.emit("grab-end", { hand: this.data.hand });
      }

      if (bPressed || yPressed) {
        this.data.hand.emit("grab-end", { hand: this.data.hand });
      }
    }
  });
  </script>

  <!-- ===== SNAP-TO-HAND ===== -->
  <script>
  AFRAME.registerComponent("snap-to-hand", {
    schema: {
      pos: {type: "vec3", default: {x:0, y:0, z:0}},
      rot: {type: "vec3", default: {x:0, y:0, z:0}}
    },

    init: function () {
      this.el.addEventListener("grab-start", (e) => {
        const hand = e.detail.hand;

        this.el.object3D.position.set(
          this.data.pos.x,
          this.data.pos.y,
          this.data.pos.z
        );

        this.el.object3D.rotation.set(
          THREE.MathUtils.degToRad(this.data.rot.x),
          THREE.MathUtils.degToRad(this.data.rot.y),
          THREE.MathUtils.degToRad(this.data.rot.z)
        );
      });
    }
  });
  </script>

</head>

<body>
  <a-scene background="color:#111"
           networked-scene="app:gorilla; room:room1; adapter:webrtc; debug:true">

    <!-- MUSIC -->
    <a-entity sound="src: url(bg.mp3); autoplay:true; loop:true"
              synced-music></a-entity>

    <!-- SKY -->
    <a-sky id="sky" color="#0a0a33" radius="500"></a-sky>

    <a-entity id="sun" light="type:directional; intensity:1"
              position="0 100 0"></a-entity>

    <a-entity id="ambient" light="type:ambient; intensity:0.5"></a-entity>
    <a-entity day-night-cycle></a-entity>

    <!-- MULTIPLAYER AVATAR TEMPLATE -->
    <a-template id="avatar-template">
      <a-entity>
        <a-sphere color="#39f" radius="0.3"></a-sphere>
      </a-entity>
    </a-template>

    <!-- PLAYER -->
    <a-entity id="player"
              networked="template:#avatar-template; attachTemplateToLocal:false">

      <a-entity id="rig" position="0 3 0" snap-turn gorilla-physics>
        <a-camera look-controls camera="near:0.05"></a-camera>

        <!-- Controller tracking -->
        <a-entity id="lc" tracked-controls="hand:left"></a-entity>
        <a-entity id="rc" tracked-controls="hand:right"></a-entity>

        <!-- Gorilla Tag hands -->
        <a-entity id="leftHand" hand-follow="target:#lc" vr-grab="hand:#leftHand">
          <a-box width="0.18" height="0.06" depth="0.28" color="#ccc"></a-box>
          <a-sphere radius="0.15" visible="false"></a-sphere>
        </a-entity>

        <a-entity id="rightHand" hand-follow="target:#rc" vr-grab="hand:#rightHand">
          <a-box width="0.18" height="0.06" depth="0.28" color="#ccc"></a-box>
          <a-sphere radius="0.15" visible="false"></a-sphere>
        </a-entity>

        <!-- Body -->
        <a-sphere position="0 0.5 0" radius="0.4" color="#444"></a-sphere>
      </a-entity>
    </a-entity>

    <!-- WORLD -->
    <a-plane class="climbable" rotation="-90 0 0" width="100" height="100" color="#222"></a-plane>
    <a-box class="climbable" position="0 0.5 -5" width="5" height="1" depth="1" color="#555"></a-box>

    <!-- PICKAXE -->
    <a-entity id="pickaxe"
              gltf-model="url(pickaxe.glb)"
              position="0 0.6 -2"
              rotation="0 45 0"
              scale="0.08 0.08 0.08"
              pickup
              snap-to-hand="pos: 0.05 -0.05 -0.15; rot: 0 90 -90">
    </a-entity>

  </a-scene>
</body>
</html>
