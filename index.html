<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gorilla Tag Movement - Fixed</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
    AFRAME.registerComponent('gtag-movement', {
      schema: {
        rig: { type: 'selector' },
        speed: { default: 1.5 },
        friction: { default: 0.94 },
        gravity: { default: -20 }
      },

      init() {
        this.vx = 0; this.vy = 0; this.vz = 0;
        this.prevL = new THREE.Vector3();
        this.prevR = new THREE.Vector3();
        this.currL = new THREE.Vector3();
        this.currR = new THREE.Vector3();
        this.ready = false;
        this.isGrounded = false;
      },

      tick(t, dtMs) {
        if (!dtMs) return;
        const dt = dtMs / 1000;
        const rig = this.data.rig.object3D;
        const handL = document.querySelector('#leftHand')?.object3D;
        const handR = document.querySelector('#rightHand')?.object3D;

        if (!handL || !handR) return;

        this.currL.setFromMatrixPosition(handL.matrixWorld);
        this.currR.setFromMatrixPosition(handR.matrixWorld);

        if (!this.ready) {
          this.prevL.copy(this.currL);
          this.prevR.copy(this.currR);
          this.ready = true; 
          return;
        }

        const hands = [
          { curr: this.currL, prev: this.prevL },
          { curr: this.currR, prev: this.prevR }
        ];

        hands.forEach(h => {
          if (h.curr.y < 0.2) {
            const dx = h.curr.x - h.prev.x;
            const dy = h.curr.y - h.prev.y;
            const dz = h.curr.z - h.prev.z;

            if (dy < 0 || Math.abs(dx) > 0.01 || Math.abs(dz) > 0.01) {
              this.vx -= dx * this.data.speed;
              this.vy -= dy * this.data.speed;
              this.vz -= dz * this.data.speed;
            }
          }
        });

        this.prevL.copy(this.currL);
        this.prevR.copy(this.currR);

        if (!this.isGrounded) {
          this.vy += this.data.gravity * dt;
        }

        rig.position.x += this.vx;
        rig.position.y += this.vy * dt;
        rig.position.z += this.vz;

        if (rig.position.y <= 0) {
          rig.position.y = 0;
          this.vy = 0;
          this.isGrounded = true;
        } else {
          this.isGrounded = false;
        }

        this.vx *= this.data.friction;
        this.vz *= this.data.friction;
        this.vy *= 0.98; 
      }
    });

    AFRAME.registerComponent('hand-follow', {
      schema: { target: { type: 'selector' } },
      tick() {
        if (!this.data.target) return;
        this.el.object3D.position.copy(this.data.target.object3D.position);
        this.el.object3D.quaternion.copy(this.data.target.object3D.quaternion);
      }
    });
  </script>
</head>

<body>
  <a-scene renderer="antialias: true" background="color: #87CEEB">

    <a-entity light="type: hemisphere; intensity: 1.2"></a-entity>

    <a-entity id="rig" position="0 0 0" gtag-movement="rig:#rig">

      <!-- FIXED HEAD -->
      <a-entity id="head" camera position="0 1.6 0"></a-entity>

      <!-- BODY -->
      <a-entity id="body" position="0 0.8 0">
        <a-sphere radius="0.35" color="white" position="0 -0.1 0" scale="1 1.2 0.8"></a-sphere>
        <a-cylinder radius="0.12" height="0.2" color="white" position="0 0.45 0"></a-cylinder>
        <a-sphere radius="0.28" color="white" position="0 0.75 0"></a-sphere>
      </a-entity>

      <!-- FIXED QUEST CONTROLLERS -->
      <a-entity id="lc" xr-controller="hand: left"></a-entity>
      <a-entity id="rc" xr-controller="hand: right"></a-entity>

      <!-- HANDS -->
      <a-entity id="leftHand" hand-follow="target:#lc">
        <a-box width="0.22" height="0.06" depth="0.28" color="white"></a-box>
      </a-entity>

      <a-entity id="rightHand" hand-follow="target:#rc">
        <a-box width="0.22" height="0.06" depth="0.28" color="white"></a-box>
      </a-entity>

    </a-entity>

    <a-plane rotation="-90 0 0" width="100" height="100" color="#3A5F0B"></a-plane>

  </a-scene>
</body>
</html>
